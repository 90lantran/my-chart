<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<script src="../jquery/dist/jquery.js"></script>
<link rel="import" href="my-chart.html">

<dom-module id="chart-env">

<template>
	<style>
		:host{
			display: inline-block;
		}
	</style>
	<content id="chartEnv"></content>
</template>

<script>

Polymer({
is:'chart-env',
properties:{
	dataTemp:{
		type: Object,
		value: {},
		notify: true
	},
	
	measurement:{
		type: Object,
		notify: true
	},

	// dataLoaded:{
	// 	type: Boolean,
	// 	notify: true,
	// 	reflectToAttribute: true,
	// 	value : false
	// }
},

// _dataTemp: function(){
// 	console.log(this.dataTemp);
// 	this.dataLoaded = true;
// },

// attributeChanged: function() {
//  	console.log("In attributeChanged");
//  	if (this.dataLoaded == true){
//  		this._dataCreated();
//  	}
//  // 	if(this.dataXLoaded == true && this.dataYLoaded == true) {
// 	// 		this._dataCreated();
// 	// }
//  },

ready: function(){
		console.log("in ready of chart-env");

		this.asyncHandler = this.async(this.lookforDom, 1000);

		this.scopeSubtree(this, true);

		// var ds1 = this.measurement.firstDim.ds;
		// var ds2 = this.measurement.secondDim.ds;

		var self = this;

		var measKeys = Object.keys(this.measurement);

		var validDs = true;

		measKeys.forEach(function(mk){
			var currMea = self.measurement[mk]; // {ds : measurement}
			if (currMea.ds == null){
				validDs = validDs && false;
				console.log("You did not specify the data-source.");
			} 
		
		});

		if (validDs){
			this.lookforDom();
		} 
},

// Use Async method to check if data were fetched into the dom or not
// if data were in the dom, bind them to chart-env, and cancel the listener
// if data were not there, keep looking. 
lookforDom : function() {

	var self = this;

	var allAvailable = true;

	var measKeys = Object.keys(this.measurement); // firstDim, secondDim, thirdDim, ...

	console.log(measKeys);

	measKeys.forEach(function(mk) {
		m = self.measurement[mk]; // m = {ds: measurement}
		var elem = Polymer.dom(self).parentNode.querySelector('data-source[datasource-id$="' + m.ds + '"]');
		if(elem.dataResponse == undefined ) {
			allAvailable = false;
		}
	});

	console.log(allAvailable);
	console.log(self.dataTemp);
	// When all dataResponse are available, push them to dataTemp
	if(allAvailable == true) {
		this.cancelAsync(this.asyncHandler);
		measKeys.forEach(function(mk) {
			
			m = self.measurement[mk];
			self.dataTemp[m.ds] = null;
			var elem = Polymer.dom(self).parentNode.querySelector('data-source[datasource-id$="' + m.ds + '"]');
			self.dataTemp[m.ds] = elem.dataResponse; // should it be self.dataTemp[mk] ??
		});

		
		// var ds1 = document.querySelector('data-source[datasource-id$="ds1"]');
  //   	var ds2 = document.querySelector('data-source[datasource-id$="ds2"]');
		// this.dataTempx = ds1.dataResponse;
  //     	this.dataTempy = ds2.dataResponse;
	}
	console.log(self.dataTemp);
	this._dataCreated();

},

// Pre-processing data
// dataRepsonse from  <data-source> will be processed , 
// and bind them to dataX and dataY of chart  
_dataCreated: function() {
	// var dataXX = this.dataTempx;
	// var dataYY = this.dataTempy;
	console.log("In dataCreated");
	
	var self = this;

	var measKeys = Object.keys(this.measurement);

	measKeys.forEach(function(mk){
		var currMea = self.measurement[mk]; // {ds : measurement}]

		data = self.dataTemp[currMea.ds];

		self[mk] = [];
		for(var i = 0; i < data.length; i++){
			console.log(data[i]);
	          self[mk].push(data[i][currMea.measurement]);
	     }
	     console.log(self[mk]);
	});

	var numChildren = self.getEffectiveChildren().length;
	for(var index = 0; index < numChildren; index++){
		var currentChild = self.getContentChildren('#chartEnv')[index];
		currentChild.dataX = self[currentChild.dimX];
		currentChild.dataY = self[currentChild.dimY];
	}												 
}

});

</script>
</dom-module>