<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<script src="../jquery/dist/jquery.js"></script>
<link rel="import" href="my-chart.html">

<dom-module id="chart-env">

<template>
	<style>
	:host{
		display: inline-block;
	}
	</style>
	<content id="chartEnv"></content>
</template>

<script>

Polymer({
	is:'chart-env',
	properties:{
		dataTemp:{
			type: Object,
			value: {},
			notify: true
		},

		measurement:{
			type: Object,
			notify: true
		}

	},

// Listeners for interaction between 2 graphs
listeners:{
	'hover': 'onHover',
	'unHover': 'onUnhover'
},

onHover: function(e){
	// console.log("in onHover of chart-env");
	this.fire('hoverAllCharts',
		{data: e.detail} 
		);
},

onUnhover: function(e) {
	this.fire('unHoverAllCharts');
},

ready: function(){
		// console.log("in ready of chart-env");

		this.scopeSubtree(this, true);

		var self = this;

		var measKeys = Object.keys(this.measurement);

		var validDs = true;
		var staticData = false;

		measKeys.forEach(function(mk){
			var currMea = self.measurement[mk]; // {ds : measurement}

			// console.log(currMea);

			if(currMea.data != undefined && currMea.data != null) {
				console.log("inside currmeas.data");
				staticData = true;
				validDs = false;
				self.dataTemp[currMea.ds] = currMea.data;
			}
			else if (currMea.ds == null){
				validDs = validDs && false;
				console.log("You did not specify the data-source.");
			} 

		});

		if (validDs){
			this.asyncHandler = this.async(this.lookforDom, 1000);
			// this.lookforDom();
		}
		else if(staticData) {
			this._dataCreated();
		}
	},

// Use Async method to check if data were fetched into the dom or not
// if data were in the dom, bind them to chart-env, and cancel the listener
// if data were not there, keep looking. 
lookforDom : function() {


	//self.measurements["firstDim"].loaded = true;

	var self = this;

	var allAvailable = true;

	var measKeys = Object.keys(this.measurement); // firstDim, secondDim, thirdDim, ...

	// console.log(measKeys);

	measKeys.forEach(function(mk) {
		m = self.measurement[mk]; // m = {ds: measurement}
		var elem = Polymer.dom(self).parentNode.querySelector('data-source[datasource-id$="' + m.ds + '"]');
		if(elem.dataResponse == undefined ) {
			allAvailable = false;
		}
	});

	// console.log(allAvailable);
	// console.log(self.dataTemp);
	// When all dataResponse are available, push them to dataTemp
	if(allAvailable == true) {
		this.cancelAsync(this.asyncHandler);
		measKeys.forEach(function(mk) {
			
			m = self.measurement[mk];
			self.dataTemp[m.ds] = null;
			var elem = Polymer.dom(self).parentNode.querySelector('data-source[datasource-id$="' + m.ds + '"]');
			self.dataTemp[m.ds] = elem.dataResponse; 
		});
	}
	// console.log(self.dataTemp);
	this._dataCreated();

},

// Pre-processing data
// dataRepsonse from  <data-source> will be processed , 
// and bind them to dataX and dataY of chart  
_dataCreated: function() {
	// console.log("In dataCreated");
	var self = this;

	var measKeys = Object.keys(this.measurement);

	measKeys.forEach(function(mk){
		var currMea = self.measurement[mk]; // {ds : measurement}]

		// console.log(currMea);

		data = self.dataTemp[currMea.ds];

		self[mk] = [];
		for(var i = 0; i < data.length; i++){
			self[mk].push(data[i][currMea.measurement]);
		}
	});

	var numChildren = self.getEffectiveChildren().length;
	for(var index = 0; index < numChildren; index++){
		var currentChild = self.getContentChildren('#chartEnv')[index];

		var tdx = currentChild.dimX || currentChild.getAttribute("dim-x");
		var tdy = currentChild.dimY || currentChild.getAttribute("dim-y");

		currentChild.dataX = self[tdx];
		currentChild.dataY = self[tdy];
	}												 
}

});

</script>
</dom-module>